<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const form = document.getElementById('regForm');
const phone = document.getElementById('phone');
const phoneError = document.getElementById('phoneError');
const survey = document.getElementById('survey');
const surveyBtn = document.getElementById('surveyBtn');
const goal = document.getElementById('goal');
const experience = document.getElementById('experience');

const steps = [
  document.getElementById('step1'),
  document.getElementById('step2'),
  document.getElementById('step3'),
  document.getElementById('step4')
];

function showStep(index){
  steps.forEach(s => s.classList.remove('active'));
  survey.classList.remove('active');
  if(index >= 0 && index < steps.length) steps[index].classList.add('active');
}

// --- Supabase setup ---
const supabaseUrl = 'https://geazefwmcocuotixqlyf.supabase.co';
const supabaseKey = 'твій-ключ-supabase';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// --- Submit форми ---
form.addEventListener('submit', function(e){
  e.preventDefault();
  const phoneValue = phone.value.trim();
  const phoneRegex = /^[0-9]{9,10}$/;

  if(!phoneRegex.test(phoneValue)){
    phoneError.style.display = 'block';
    phone.focus();
    return false;
  } else {
    phoneError.style.display = 'none';
  }

  const tempUser = {
    firstName: document.getElementById('firstName').value,
    lastName: document.getElementById('lastName').value,
    email: document.getElementById('email').value,
    prefix: document.getElementById('prefix').value,
    phone: phoneValue,
    date: new Date().toLocaleString()
  };

  localStorage.setItem('tempUser', JSON.stringify(tempUser));
  form.style.display = 'none';
  survey.classList.add('active');
});

// --- Submit survey ---
surveyBtn.addEventListener('click', async function(){
  if(!goal.value || !experience.value){
    alert('Seleziona tutte le opzioni!');
    return;
  }

  const userData = JSON.parse(localStorage.getItem('tempUser'));
  userData.goal = goal.value;
  userData.experience = experience.value;

  // --- Відправка на Supabase ---
  try {
    const { data, error } = await supabase.from('users').insert([userData]);
    if(error){
      console.error('Supabase error:', error);
      alert('Si è verificato un errore durante l\'invio dei dati.');
    } else {
      console.log('Supabase data saved:', data);
    }
  } catch(err){
    console.error(err);
    alert('Errore di rete.');
  }

  // --- Локальне збереження ---
  let users = JSON.parse(localStorage.getItem('users')) || [];
  users.push(userData);
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.removeItem('tempUser');

  // --- Показуємо flow ---
  survey.classList.remove('active');
  showStep(0);
  setTimeout(()=>{ showStep(1); }, 2000);
  setTimeout(()=>{ showStep(2); }, 4000);
  setTimeout(()=>{ showStep(3); }, 6000);
});
</script>
