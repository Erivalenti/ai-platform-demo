<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Walton Market - Registrazione</title>
<link rel="icon" href="https://back.wltnmarket.com/storage/images/logo/dark.png" type="image/png">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Montserrat',sans-serif;}
  body{background:linear-gradient(135deg,#0d1117,#1a1f2b);color:white;display:flex;justify-content:center;align-items:center;height:100vh;}
  .container{background:rgba(20,25,40,0.95);padding:40px 30px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.7);width:350px;text-align:center;}
  .container img{height:60px;margin-bottom:20px;}
  h2{margin-bottom:20px;}
  input, select{width:100%;padding:12px 15px;margin-bottom:15px;border-radius:10px;border:none;font-size:1rem;}
  input:focus, select:focus{outline:none;box-shadow:0 0 10px rgba(255,110,196,0.5);}
  .btn{padding:12px 30px;font-size:1.2rem;color:white;background:linear-gradient(45deg,#ff6ec4,#7873f5);border:none;border-radius:50px;cursor:pointer;transition:0.3s;box-shadow:0 5px 25px rgba(0,0,0,0.6);}
  .btn:hover{transform:scale(1.05);box-shadow:0 10px 35px rgba(0,0,0,0.8);}
  .error{color:#ff6e6e;font-size:0.9rem;margin-top:-10px;margin-bottom:10px;display:none;text-align:left;}
  .step{display:none;flex-direction:column;align-items:center;justify-content:center;}
  .step.active{display:flex;}
  .check{font-size:50px;color:#4ade80;margin-bottom:15px;}
  .loading{margin-bottom:15px;font-size:1.2rem;}
</style>
</head>
<body>

<div class="container" id="container">
  <img src="https://back.wltnmarket.com/storage/images/logo/dark.png" alt="Walton Market Logo">
  <h2>Registrazione</h2>

  <!-- Форма -->
  <form id="regForm">
    <input type="text" id="firstName" placeholder="Nome" required>
    <input type="text" id="lastName" placeholder="Cognome" required>
    <input type="email" id="email" placeholder="Email" required>
    <select id="prefix">
      <option value="+39" selected>+39 Italia</option>
      <option value="+44">+44 UK</option>
      <option value="+1">+1 USA</option>
      <option value="+49">+49 Germania</option>
      <option value="+33">+33 Francia</option>
    </select>
    <input type="tel" id="phone" placeholder="Numero di telefono" required>
    <div class="error" id="phoneError">Inserisci un numero valido</div>
    <button type="submit" class="btn">Registrati</button>
  </form>

  <!-- Опитування -->
  <div class="step" id="survey">
    <h2>Piccolo sondaggio</h2>
    <p>Qual è il tuo obiettivo principale con Walton Market?</p>
    <select id="goal" required>
      <option value="" disabled selected>Seleziona un'opzione</option>
      <option value="profitto">Profitto rapido</option>
      <option value="investimento">Investimento a lungo termine</option>
      <option value="apprendimento">Imparare trading</option>
    </select>
    <p>Hai già esperienza di trading?</p>
    <select id="experience" required>
      <option value="" disabled selected>Seleziona un'opzione</option>
      <option value="nessuna">Nessuna</option>
      <option value="base">Base</option>
      <option value="avanzata">Avanzata</option>
    </select>
    <button class="btn" id="surveyBtn">Avanti</button>
  </div>

  <!-- Flow steps -->
  <div class="step" id="step1"><div class="loading">Caricamento...</div></div>
  <div class="step" id="step2"><div class="check">✔</div><div>Registrazione completata!</div></div>
  <div class="step" id="step3"><div class="loading">Ricerca support-manager...</div></div>
  <div class="step" id="step4"><div class="check">✔</div><div><strong>Manager:</strong> Erica Valenti<br><strong>Whatsapp:</strong> +34 676 70 61 00<br><strong>Email:</strong> erica.valenti@waltonmarketltd.email</div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const form = document.getElementById('regForm');
const phone = document.getElementById('phone');
const phoneError = document.getElementById('phoneError');
const survey = document.getElementById('survey');
const surveyBtn = document.getElementById('surveyBtn');
const goal = document.getElementById('goal');
const experience = document.getElementById('experience');
const steps = [
  document.getElementById('step1'), 
  document.getElementById('step2'), 
  document.getElementById('step3'), 
  document.getElementById('step4')
];

// Supabase
const supabaseUrl = 'https://geazefwmcocuotixqlyf.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlYXplZndtY29jdW90aXhxbHlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTg3MTYsImV4cCI6MjA3NTQ5NDcxNn0.r0jfc5EITj47Hve-IuSYABfTDz4_-_5j76AYrpptf68';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

function showStep(index){
  steps.forEach(s => s.classList.remove('active'));
  survey.classList.remove('active');
  if(index >= 0 && index < steps.length) steps[index].classList.add('active');
}

// Форма сабміт → показати опитування
form.addEventListener('submit', e => {
  e.preventDefault();

  const phoneValue = phone.value.replace(/\D/g,''); 
  if(!/^[0-9]{9,10}$/.test(phoneValue)){
    phoneError.style.display = 'block';
    phone.focus();
    return;
  }
  phoneError.style.display = 'none';

  const tempUser = {
    firstName: document.getElementById('firstName').value,
    lastName: document.getElementById('lastName').value,
    email: document.getElementById('email').value,
    prefix: document.getElementById('prefix').value,
    phone: phoneValue,
    date: new Date().toLocaleString()
  };

  localStorage.setItem('tempUser', JSON.stringify(tempUser));
  form.style.display = 'none';
  survey.classList.add('active');
});

// Опитування сабміт → старт flow + вставка Supabase
surveyBtn.addEventListener('click', () => {
  if(!goal.value || !experience.value){
    alert('Seleziona tutte le opzioni!');
    return;
  }

  const userData = JSON.parse(localStorage.getItem('tempUser'));
  userData.goal = goal.value;
  userData.experience = experience.value;

  survey.classList.remove('active');
  showStep(0); // step1 - loading

  // Вставка в Supabase вже на кроці пошуку агента
  (async () => {
    try {
      const { data, error } = await supabase.from('users').insert([userData]);
      if(error) console.error('Supabase error:', error);
      else console.log('Saved to Supabase:', data);
    } catch(err) {
      console.error(err);
    }
    localStorage.removeItem('tempUser');
  })();

  // Flow кроки
  setTimeout(() => showStep(1), 2000); // Registrazione completata
  setTimeout(() => showStep(2), 4000); // Ricerca support-manager
  setTimeout(() => showStep(3), 6000); // Показ агента
});
</script>
</body>
</html>
